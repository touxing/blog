<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Jenkins | 磨刀</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/blog/img/logo-64.png">
    <meta name="description" content="Vue 驱动的静态网站生成器">
    
    <link rel="preload" href="/blog/assets/css/0.styles.f68c8556.css" as="style"><link rel="preload" href="/blog/assets/js/app.ea7845fc.js" as="script"><link rel="preload" href="/blog/assets/js/2.ad14101e.js" as="script"><link rel="preload" href="/blog/assets/js/44.eadba82f.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.a9c951a9.js"><link rel="prefetch" href="/blog/assets/js/11.fccd85ba.js"><link rel="prefetch" href="/blog/assets/js/12.ba5cb0f5.js"><link rel="prefetch" href="/blog/assets/js/13.cfdd3ae5.js"><link rel="prefetch" href="/blog/assets/js/14.98889a27.js"><link rel="prefetch" href="/blog/assets/js/15.16cdc52d.js"><link rel="prefetch" href="/blog/assets/js/16.9a7db3f0.js"><link rel="prefetch" href="/blog/assets/js/17.2261a8c6.js"><link rel="prefetch" href="/blog/assets/js/18.1a2a214c.js"><link rel="prefetch" href="/blog/assets/js/19.4b8a7c6e.js"><link rel="prefetch" href="/blog/assets/js/20.97ac70ae.js"><link rel="prefetch" href="/blog/assets/js/21.795462a4.js"><link rel="prefetch" href="/blog/assets/js/22.a2de115c.js"><link rel="prefetch" href="/blog/assets/js/23.54cd155e.js"><link rel="prefetch" href="/blog/assets/js/24.5bb53da4.js"><link rel="prefetch" href="/blog/assets/js/25.b61c5c91.js"><link rel="prefetch" href="/blog/assets/js/26.ce4b2108.js"><link rel="prefetch" href="/blog/assets/js/27.650c38c0.js"><link rel="prefetch" href="/blog/assets/js/28.5ee27de4.js"><link rel="prefetch" href="/blog/assets/js/29.9b1c4237.js"><link rel="prefetch" href="/blog/assets/js/3.4f0e758c.js"><link rel="prefetch" href="/blog/assets/js/30.89b977e1.js"><link rel="prefetch" href="/blog/assets/js/31.34cdce0b.js"><link rel="prefetch" href="/blog/assets/js/32.1800b39c.js"><link rel="prefetch" href="/blog/assets/js/33.083d8f27.js"><link rel="prefetch" href="/blog/assets/js/34.a3ec603c.js"><link rel="prefetch" href="/blog/assets/js/35.13d2852c.js"><link rel="prefetch" href="/blog/assets/js/36.863f5e60.js"><link rel="prefetch" href="/blog/assets/js/37.2fb61868.js"><link rel="prefetch" href="/blog/assets/js/38.b350ff89.js"><link rel="prefetch" href="/blog/assets/js/39.dcc7a2d1.js"><link rel="prefetch" href="/blog/assets/js/4.296f99f7.js"><link rel="prefetch" href="/blog/assets/js/40.88d05988.js"><link rel="prefetch" href="/blog/assets/js/41.96e9671f.js"><link rel="prefetch" href="/blog/assets/js/42.6d046ffc.js"><link rel="prefetch" href="/blog/assets/js/43.f963f56e.js"><link rel="prefetch" href="/blog/assets/js/45.b104845a.js"><link rel="prefetch" href="/blog/assets/js/46.0f4c7a5f.js"><link rel="prefetch" href="/blog/assets/js/47.ec203417.js"><link rel="prefetch" href="/blog/assets/js/48.01dad4b7.js"><link rel="prefetch" href="/blog/assets/js/49.97f147ed.js"><link rel="prefetch" href="/blog/assets/js/5.eee10e77.js"><link rel="prefetch" href="/blog/assets/js/50.159364ec.js"><link rel="prefetch" href="/blog/assets/js/51.86a53ed7.js"><link rel="prefetch" href="/blog/assets/js/52.b806c8a8.js"><link rel="prefetch" href="/blog/assets/js/53.a32c429a.js"><link rel="prefetch" href="/blog/assets/js/54.dfdf6b5f.js"><link rel="prefetch" href="/blog/assets/js/55.2dca2bd6.js"><link rel="prefetch" href="/blog/assets/js/56.b58481d3.js"><link rel="prefetch" href="/blog/assets/js/57.e18eb49f.js"><link rel="prefetch" href="/blog/assets/js/58.90288d73.js"><link rel="prefetch" href="/blog/assets/js/59.f772c857.js"><link rel="prefetch" href="/blog/assets/js/6.5bb04a21.js"><link rel="prefetch" href="/blog/assets/js/60.93deb504.js"><link rel="prefetch" href="/blog/assets/js/61.71a83d4c.js"><link rel="prefetch" href="/blog/assets/js/62.58455d56.js"><link rel="prefetch" href="/blog/assets/js/63.9a042662.js"><link rel="prefetch" href="/blog/assets/js/64.d64fbd9a.js"><link rel="prefetch" href="/blog/assets/js/65.a3a30a06.js"><link rel="prefetch" href="/blog/assets/js/66.26109f57.js"><link rel="prefetch" href="/blog/assets/js/67.a6b65e99.js"><link rel="prefetch" href="/blog/assets/js/68.8eb33d54.js"><link rel="prefetch" href="/blog/assets/js/69.b1c6c6eb.js"><link rel="prefetch" href="/blog/assets/js/7.71d6bbec.js"><link rel="prefetch" href="/blog/assets/js/70.acceb640.js"><link rel="prefetch" href="/blog/assets/js/71.0fc78508.js"><link rel="prefetch" href="/blog/assets/js/72.4eb8af25.js"><link rel="prefetch" href="/blog/assets/js/73.198221e0.js"><link rel="prefetch" href="/blog/assets/js/74.fadf8b50.js"><link rel="prefetch" href="/blog/assets/js/75.79f25e16.js"><link rel="prefetch" href="/blog/assets/js/76.3df5e2d5.js"><link rel="prefetch" href="/blog/assets/js/77.f5a243c5.js"><link rel="prefetch" href="/blog/assets/js/78.77ebe94e.js"><link rel="prefetch" href="/blog/assets/js/79.ddc4b6d5.js"><link rel="prefetch" href="/blog/assets/js/8.dec9a7fe.js"><link rel="prefetch" href="/blog/assets/js/80.6808aa51.js"><link rel="prefetch" href="/blog/assets/js/81.0759c12d.js"><link rel="prefetch" href="/blog/assets/js/82.61778842.js"><link rel="prefetch" href="/blog/assets/js/83.0707a5df.js"><link rel="prefetch" href="/blog/assets/js/84.bb7b7271.js"><link rel="prefetch" href="/blog/assets/js/85.7c032704.js"><link rel="prefetch" href="/blog/assets/js/86.e6d50b87.js"><link rel="prefetch" href="/blog/assets/js/87.c79e6302.js"><link rel="prefetch" href="/blog/assets/js/88.9bdb0039.js"><link rel="prefetch" href="/blog/assets/js/89.423511bb.js"><link rel="prefetch" href="/blog/assets/js/9.9a14bac7.js"><link rel="prefetch" href="/blog/assets/js/90.78282a92.js"><link rel="prefetch" href="/blog/assets/js/91.e24ccf16.js"><link rel="prefetch" href="/blog/assets/js/92.2154c88e.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.f68c8556.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/zh/" class="home-link router-link-active"><img src="/blog/img/logo-64.png" alt="磨刀" class="logo"> <span class="site-name can-hide">磨刀</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/zh/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Note Menu" class="dropdown-title"><span class="title">Note</span> <span class="arrow down"></span></button> <button type="button" aria-label="Note Menu" class="mobile-dropdown-title"><span class="title">Note</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          前端
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/zh/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-subitem"><a href="/blog/zh/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-subitem"><a href="/blog/zh/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-subitem"><a href="/blog/zh/git/" class="nav-link">
  Git
</a></li><li class="dropdown-subitem"><a href="/blog/zh/tools/" class="nav-link">
  工具利器
</a></li><li class="dropdown-subitem"><a href="/blog/zh/javascript/#设计模式" class="nav-link">
  设计模式
</a></li><li class="dropdown-subitem"><a href="/blog/zh/algo/" class="nav-link">
  算法
</a></li><li class="dropdown-subitem"><a href="/blog/zh/analyzes/" class="nav-link">
  数据分析
</a></li><li class="dropdown-subitem"><a href="/blog/zh/面试/" class="nav-link">
  面试
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/blog/zh/backend/" class="nav-link">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/note/" class="nav-link">
  随笔
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/touxing" target="_blank" rel="hotsuitor blog" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/" class="nav-link">
  en-US
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/deploy/jenkins.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/zh/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Note Menu" class="dropdown-title"><span class="title">Note</span> <span class="arrow down"></span></button> <button type="button" aria-label="Note Menu" class="mobile-dropdown-title"><span class="title">Note</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          前端
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/zh/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-subitem"><a href="/blog/zh/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-subitem"><a href="/blog/zh/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-subitem"><a href="/blog/zh/git/" class="nav-link">
  Git
</a></li><li class="dropdown-subitem"><a href="/blog/zh/tools/" class="nav-link">
  工具利器
</a></li><li class="dropdown-subitem"><a href="/blog/zh/javascript/#设计模式" class="nav-link">
  设计模式
</a></li><li class="dropdown-subitem"><a href="/blog/zh/algo/" class="nav-link">
  算法
</a></li><li class="dropdown-subitem"><a href="/blog/zh/analyzes/" class="nav-link">
  数据分析
</a></li><li class="dropdown-subitem"><a href="/blog/zh/面试/" class="nav-link">
  面试
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/blog/zh/backend/" class="nav-link">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/note/" class="nav-link">
  随笔
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/touxing" target="_blank" rel="hotsuitor blog" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/" class="nav-link">
  en-US
</a></li><li class="dropdown-item"><!----> <a href="/blog/zh/deploy/jenkins.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/zh/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/blog/zh/html/" class="sidebar-link">HTML</a></li><li><a href="/blog/zh/css/" class="sidebar-link">CSS</a></li><li><a href="/blog/zh/javascript/" class="sidebar-link">JavaScript</a></li><li><a href="/blog/zh/algo/" class="sidebar-link">算法</a></li><li><a href="/blog/zh/deploy/" aria-current="page" class="sidebar-link">部署</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/zh/tools/" class="sidebar-heading clickable"><span>工具利器</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/zh/TODO" class="sidebar-heading clickable"><span>TODO</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/blog/zh/english/" class="sidebar-link">英语</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="jenkins"><a href="#jenkins" class="header-anchor">#</a> Jenkins</h1> <h2 id="安装-基于centos"><a href="#安装-基于centos" class="header-anchor">#</a> 安装（基于CentOS)</h2> <p><a href="https://www.jenkins.io/zh" target="_blank" rel="noopener noreferrer">官网教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
三种安装方式</p> <ul><li>下载 war 包，Tomcat中运行 <code>java -jar jenkins.war --HttpPort=8080</code></li> <li>yum 安装</li> <li>docker 安装（推荐）</li></ul> <p>根据官网安装 Docker 环境</p> <blockquote><p>国内配置清华源
Fedora/CentOS/RHEL
以下内容根据 官方文档 修改而来。</p></blockquote> <p>如果你之前安装过 docker，请先删掉</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> yum remove <span class="token function">docker</span> docker-common docker-selinux docker-engine
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装一些依赖</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils device-mapper-persistent-data lvm2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>根据你的发行版下载repo文件:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">wget</span> <span class="token parameter variable">-O</span> /etc/yum.repos.d/docker-ce.repo https://download.docker.com/linux/centos/docker-ce.repo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>把软件仓库地址替换为 TUNA:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+'</span> /etc/yum.repos.d/docker-ce.repo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>最后安装:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>sudo yum makecache fast
sudo yum install docker-ce
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>安装Jenkins</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token punctuation">\</span>
  <span class="token parameter variable">-u</span> root <span class="token punctuation">\</span>
  <span class="token parameter variable">--rm</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-p</span> <span class="token number">8080</span>:8080 <span class="token punctuation">\</span>
  <span class="token parameter variable">-p</span> <span class="token number">50000</span>:50000 <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> jenkins-data:/var/jenkins_home <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> /var/run/docker.sock:/var/run/docker.sock <span class="token punctuation">\</span>
  jenkinsci/blueocean
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="构建nodejs应用"><a href="#构建nodejs应用" class="header-anchor">#</a> 构建nodejs应用</h2> <p>安装插件：</p> <ul><li>Nodejs</li> <li>Git 从仓库拉取代码构建</li> <li>Git Pramater 可选，用于配置选择构建不同的分支</li></ul> <ol><li>创建一个任务，选择 <code>FreeStyle Project</code> 自由风格工程</li> <li>配置 git 仓库，配置秘钥（或HTTPS方式的配置密码）</li> <li>构建环境，选择 nodejs</li> <li>构建，选择执行 shell 配置构建命令 eg: <code>npm install &amp;&amp; npm build</code> 根据实际需求配置</li> <li>构建后执行，可选，可以配置部署到线上环境</li></ol> <h2 id="使用pipeline方式构建vue项目应用示例"><a href="#使用pipeline方式构建vue项目应用示例" class="header-anchor">#</a> 使用pipeline方式构建vue项目应用示例</h2> <ol><li>创建项目，选择 pipeline 单分支工程</li> <li>配置 pipeline 脚本，或者选择 <code>pipeline from SCM</code></li></ol> <p>脚本示例：</p> <div class="language-grooxy line-numbers-mode"><pre class="language-text"><code>def url = &quot;https://oauth2:xxxxxxxxxxxxxx@gitlab.com/xxx/xxx.git&quot;
def remote_directory = &quot;/data/project/xxxx/web/&quot;
def email_from = &quot;jenkins@xxx.com&quot;
def email_to = &quot;&quot;&quot;
jenkins@xxx.com,
jenkins2@xxx.com,
&quot;&quot;&quot;

pipeline {
  agent any
  parameters {
    // 需要安装 Git Parameter Plugin
    gitParameter name: 'BRANCH_TAG',
                 type: 'PT_BRANCH_TAG',
                 branchFilter: 'origin/(.*)',
                 defaultValue: 'master',
                 selectedValue: 'DEFAULT',
                 sortMode: 'ASCENDING_SMART',
                 description: 'Select your branch or tag.'
    choice choices: ['test', 'uat', 'prod'], description: '请选择打包环境', name: 'ENV'
  }
  // 需要安装 Generic Trigger Plugin
  triggers {
        GenericTrigger (
            // 构建时的标题
            causeString: 'Triggered by $ref',
            // 获取POST参数中的变量，key指的是变量名，通过$ref来访问对应的值，value指的是JSON匹配值（参考Jmeter的JSON提取器）
            // ref指的是推送的分支，格式如：refs/heads/master
            genericVariables: [
              [key: 'ref', value: '$.ref'],
            ],
            // 打印获取的变量的key-value，此处会打印如：ref=refs/heads/master
            printContributedVariables: true,
            // 打印POST传递的参数
            printPostContent: true,
            // regexpFilterExpression与regexpFilterExpression成对使用
            // 当两者相等时，会触发对应分支的构建
            regexpFilterExpression: '^refs/heads/(master|main|develop|release.*|feature.*|hotfix.*|bugfix.*)$',
            regexpFilterText: '$ref',
            // 与webhook中配置的token参数值一致
            token: 'admin-dist'
        )
  }
  stages {
    stage('echo env') {
      steps {
        sh 'pwd'
        sh 'printenv'
      }
    }
    stage(&quot;hook info&quot;) {
      steps {
        sh 'printenv'
        script {
          try{
            echo &quot;参数：$ref&quot;
            if(&quot;$ref&quot; != &quot;&quot;){
              println &quot;----------webhook式触发-----------&quot;
              // BRANCH_NAME 是多分支特有的变量
              branchName = sh(returnStdout: true, script: ''' echo $ref | sed s#refs/heads/## ''').trim()
              println &quot;webhook触发的分支是: &quot; + &quot;${branchName}&quot;
            }
          } catch(exc) {
            echo &quot;error: ${exc}&quot;
            echo &quot;BRANCH_TAG ${params.BRANCH_TAG}&quot;
            if(&quot;${params.BRANCH_TAG}&quot; != &quot;master&quot;){
              println &quot;-----------手动方式触发------------&quot;
              branchName = &quot;${params.BRANCH_TAG}&quot;
              println &quot;手动触发的分支是: &quot; + &quot;${branchName}&quot;
            }
          }
          env.BRANCH_NAME = branchName
        }
      }
    }
    stage(&quot;手动参数选择分支&quot;) {
      when {
        expression { return &quot;${branchName}&quot; != &quot;master&quot;}
      }
      steps{
        checkout([$class: 'GitSCM',
                          // branches: [[name: &quot;${params.BRANCH_TAG}&quot;]],
                          branches: [[name: &quot;${branchName}&quot;]],
                          doGenerateSubmoduleConfigurations: false,
                          extensions: [],
                          submoduleCfg: [],
                          userRemoteConfigs: [[
                            url: &quot;${url}&quot;,
                            // credentialsId: 'for_gitlab',
                          ]]
                        ])
      }
    }
    stage(&quot;git info&quot;) {
      steps {
        script {
          //  git branch -v |grep '*' | cut -d ' ' -f2  // 在jenkins上执行没有正确返回当前分支名
          branch_name = sh(returnStdout: true, script: ''' echo $ref | sed s#refs/heads/## ''').trim()
          commits_id = sh(returnStdout: true, script: ''' git rev-parse HEAD ''').trim()
          git_url = sh(returnStdout: true, script: ''' git remote -v | awk 'NR==1 {print $(NF-1)}' | sed 's/oauth.*@'//g ''').trim()
          commit_log = sh(returnStdout: true, script: ''' git log --pretty=format:&quot;%h - %an, %ar =&gt; %s&quot; | awk 'NR==1{print}' ''').trim()
        }
        echo &quot;${branch_name} ${git_url} ${commits_id} ${commit_log}&quot;
      }
    }
    stage('npm打包') {
      steps {
        //使用NodeJS的npm进行打包
        nodejs('nodejs14'){
            sh '''
                yarn
                yarn build
              '''
        }
      }
    }
    stage('远程部署') {
      options {
        timeout(time: 3, unit: 'HOURS')
      }
      input {
        message &quot;将${env.BRANCH_NAME}分支部署到${ENV}环境服务器?&quot;
        ok &quot;是的&quot;
        parameters {
            booleanParam(name: 'IS_DEPLOY', defaultValue: true, description: '打完包后，是否部署到服务器?')
        }
      }

      when { expression { return ENV != &quot;prod&quot; } } // 非 prod 环境，执行以下脚本
      steps {
        script { // 引用ENV变量进行一个逻辑判断提示
          if ( ENV == &quot;test&quot; ) {
            HOST = &quot;192.168.4.152&quot;
            remote_directory = &quot;/data/project/xxx/web/&quot;
          } else if ( ENV == &quot;uat&quot; ) {
            HOST = &quot;192.168.4.42&quot;
            remote_directory = &quot;/home/xxx/web/&quot;
          }
          echo &quot;server: ${HOST} address: ${remote_directory}&quot;
          //远程调用进行项目部署
          // *.js      所有js文件
          // *          只传输文件，文件夹不会传输
          // **         所有文件
          sshPublisher(publishers: [sshPublisherDesc(configName: &quot;${HOST}&quot;,
                                                     transfers: [sshTransfer( cleanRemote: true,
                                                                               excludes: '',
                                                                               execCommand: '',
                                                                               execTimeout: 120000,
                                                                               flatten: false,
                                                                               makeEmptyDirs: false,
                                                                               noDefaultExcludes:false,
                                                                               patternSeparator: '[, ]+',
                                                                               remoteDirectory: &quot;${remote_directory}&quot;,
                                                                               remoteDirectorySDF: false,
                                                                               removePrefix: 'dist/',
                                                                               sourceFiles: 'dist/**')],
                                                      usePromotionTimestamp: false,
                                                      useWorkspaceInPromotion: false,
                                                      verbose: true)])


        }
      }
    }
    stage(&quot;chore&quot;) {
      steps {
        script {
          echo &quot;已经部署到${ENV}环境&quot;
          if ( ENV == 'prod' ) {
            echo &quot;生成环境部署不可用，只能模拟打包&quot;
            // catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
            //   sh &quot;exit 1&quot;
            // }
          }
        }
        sh &quot;&quot;&quot;
        pwd
        tar -zcf admin-dist.tar.gz -C dist . # 打包dist目录的内容，不包括dist目录自身
        ls -al dist* admin-dist*
        &quot;&quot;&quot;
      }
    }
  }
  post {
    success {
      script {
        echo '恭喜您，构建成功！！！'
        // emailNotify(&quot;构建成功&quot;, &quot;color:green;&quot;)
        weiXinNotify()
        archiveArtifacts artifacts: 'admin-dist*.gz',
                          allowEmptyArchive: true,
                          fingerprint: true,
                          onlyIfSuccessful: true
      }
    }
    failure {
      script {
        echo '抱歉，构建失败！！！'
        // emailNotify('构建失败', 'color:red;')
        weiXinNotify()
      }
    }
  }
}


// 邮件通知
def emailNotify(TITLE_TXT, color_style) {
  // TITLE_TXT = '构建成功'
  // color_style = 'color:green;'
  email_subject = &quot;${env.BUILD_TAG} ${ENV}环境 ${TITLE_TXT}&quot;
  email_body = &quot;&quot;&quot;
  &lt;div&gt;
  &lt;h1&gt;CI报告&lt;/h1&gt;
  &lt;h2&gt;(本邮件是程序自动下发，请勿回复！)&lt;/h2&gt;
  &lt;div&gt;
      &lt;h2&gt;Jenkins 运行结果&lt;/h2&gt;
      &lt;ul&gt;
      &lt;li&gt;jenkins的执行结果 : &lt;strong style=&quot;${color_style}&quot;&gt;jenkins ${TITLE_TXT}&lt;/strong&gt;&lt;/li&gt;
      &lt;li&gt;构建环境  : &lt;strong&gt;${ENV}&lt;/strong&gt;&lt;/li&gt;
      &lt;li&gt;jenkins项目名称 : &lt;strong&gt;${env.JOB_NAME}&lt;/strong&gt;&lt;/li&gt;
      &lt;li&gt;jenkins的打包tag : &lt;strong&gt;${env.BUILD_TAG}&lt;/strong&gt;&lt;/li&gt;
      &lt;li&gt;jenkins的Job编号 : &lt;strong&gt;${env.BUILD_NUMBER}&lt;/strong&gt;&lt;/li&gt;
      &lt;li&gt;jenkins的URL : &lt;a href=&quot;${env.BUILD_URL}&quot;&gt;${env.BUILD_URL}&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;Job URL : &lt;a href=&quot;${env.JOB_URL}&quot;&gt;${env.JOB_URL}&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;构建日志：&lt;a href=&quot;${BUILD_URL}console&quot;&gt;${BUILD_URL}console&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;变更历史：&lt;a href=&quot;${BUILD_URL}changes&quot;&gt;${BUILD_URL}changes&lt;/a&gt;&lt;/li&gt;
      &lt;/ul&gt;
  &lt;/div&gt;
  &lt;div&gt;
  &lt;h2&gt;GIT 信息&lt;/h2&gt;
  &lt;ul&gt;
      &lt;li&gt;GIT项目的地址 : &lt;a href=&quot;${git_url}&quot;&gt;${git_url}&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;GIT项目构建 : &lt;strong&gt;${env.BRANCH_TAG}&lt;/strong&gt;&lt;/li&gt;
      &lt;li&gt;GIT最后一次提交 : &lt;strong&gt;${commit_log}&lt;/strong&gt;&lt;/li&gt;
  &lt;/ul&gt;
  &lt;/div&gt;
  &lt;/div&gt;
  &quot;&quot;&quot;
  mail subject: email_subject,
        body: email_body,
        charset: 'utf-8',
        from: &quot;${email_from}&quot;,
        mimeType: 'text/html',
        to: &quot;${email_to}&quot;
}

// 企业微信机器人通知
def weiXinNotify(){
    // 不明文显示敏感信息，在全局-凭证管理中设置
    // withCredentials([string(credentialsId: '8adc7117-1d83-4ef4-9e6b-4b827b3ecc4a', variable: 'TOKEN')]){
      sh &quot;&quot;&quot;
          curl --location --request POST 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=1d567052-a6e5-482a-8684-8ae9893c51a9' \
              --header 'Content-Type: application/json' \
              --data '{
                  &quot;msgtype&quot;: &quot;markdown&quot;,
                  &quot;markdown&quot;: {
                      &quot;content&quot;: &quot;## ${JOB_NAME} 作业构建信息: \n### 构建人：${env.BUILD_USER} \n### 构建环境：${params.ENV} \n### 构建分支：${branchName} \n### 作业状态： ${currentBuild.currentResult} \n### 最后记录：${commit_log} \n### 运行时长： ${currentBuild.durationString} \n###### 更多详细信息点击 [构建日志](${BUILD_URL}/console) \n&quot;
                  }
              }'
      &quot;&quot;&quot;
    // }
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2022/11/22 12:00:38</span></div></footer> <!----> </main></div><div class="global-ui"><!----><div></div></div></div>
    <script src="/blog/assets/js/app.ea7845fc.js" defer></script><script src="/blog/assets/js/2.ad14101e.js" defer></script><script src="/blog/assets/js/44.eadba82f.js" defer></script>
  </body>
</html>
